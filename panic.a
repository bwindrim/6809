        ; panic.a - fatal error handler for 6809

        include "via6522.i"
        include "globals.i"

        ORG     $0000           ; This is a relocatable module.

        leax    panic,pcr       ; Copy the address of the panic handler
        stx     g_swivec        ; to the SWI1 vector
        rts                     ; Done, return to the loader.

panic:                          ; 6809 SWI1 entry point.
        nop                     ; needed because of error in pcr assembly, above
        ldx     10,s            ; Get saved PC from stack (points at panic string)
outer:  lda     ,x+
        beq     done            ; End of string?
        sta     porta
inner:  ldb     ifr
        andb    #ca1flag
        beq     inner
        bra     outer

done:   bra done                ; Loop here forever.